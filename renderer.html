<script>
let offImage = null;
let onImage = null;

const loadImage = (src) => {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = (e) => reject(e);
    img.src = src;
  });
}

window.ipcRenderer.on('new-client', (event) => {
  // console.log('new-client', event);
  const [ port ] = event.ports
  port.onmessage = async (event) => {
    const count = event.data.count

    if (offImage === null) {
      offImage = event.data.icon
    }

    if (onImage === null) {
      const b = new Blob([event.data.icon], { type: 'image/png' });
      const img = await loadImage(URL.createObjectURL(b));
      URL.revokeObjectURL(img.src)

      const canvas = document.getElementById('canvas')
      canvas.setAttribute('width', img.width)
      canvas.setAttribute('height', img.height)
      ctx = canvas.getContext('2d')
      ctx.drawImage(img, 0, 0)
      ctx.fillStyle = 'red'

      const radius = 30
      const x = img.width - radius
      const y = img.height - radius
      ctx.beginPath()
      ctx.arc(x, y, radius, 0, 2 * Math.PI)
      ctx.fill()

      const b1 = await new Promise(resolve => canvas.toBlob(resolve));

      onImage = new Uint8Array(await b1.arrayBuffer());
    }

    if (count > 1) {
      port.postMessage({ icon: onImage })
    } else {
      port.postMessage({ icon: offImage })
    }
  }
})
</script>
<canvas id="canvas"></canvas>
